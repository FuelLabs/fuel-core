syntax = "proto3";

package blockaggregator;

message BlockHeightRequest {}

message BlockHeightResponse {
  optional uint32 height = 1;
}

message BlockRangeRequest {
  uint32 start = 1;
  uint32 end = 2;
}

message RemoteBlockRangeResponse {
  string region = 1;
  string bucket = 2;
  string key = 3;
  string url = 4;
}

message Block {
  oneof versioned_block {
    V1Block v1 = 1;
  }
}

message V1Block {
  Header header = 1;
  repeated Transaction transactions = 2;
}

message Header {
  oneof versioned_header {
    V1Header v1 = 1;
    V2Header v2 = 2;
  }
}

message V1Header {
  uint64 da_height = 1;
  uint32 consensus_parameters_version = 2;
  uint32 state_transition_bytecode_version = 3;
  uint32 transactions_count = 4;
  uint32 message_receipt_count = 5;
  bytes transactions_root = 6;
  bytes message_outbox_root = 7;
  bytes event_inbox_root = 8;
  bytes prev_root = 9;
  uint32 height = 10;
  uint64 time = 11;
  bytes application_hash = 12;
  optional bytes block_id = 13;
}

message V2Header {
  uint64 da_height = 1;
  uint32 consensus_parameters_version = 2;
  uint32 state_transition_bytecode_version = 3;
  uint32 transactions_count = 4;
  uint32 message_receipt_count = 5;
  bytes transactions_root = 6;
  bytes message_outbox_root = 7;
  bytes event_inbox_root = 8;
  bytes tx_id_commitment = 9;
  bytes prev_root = 10;
  uint32 height = 11;
  uint64 time = 12;
  bytes application_hash = 13;
  optional bytes block_id = 14;
}

message Transaction {
  oneof variant {
    ScriptTransaction script = 1;
    CreateTransaction create = 2;
    MintTransaction mint = 3;
    UpgradeTransaction upgrade = 4;
    UploadTransaction upload = 5;
    BlobTransaction blob = 6;
  }
}

message ScriptTransaction {
  uint64 script_gas_limit = 1;
  bytes receipts_root = 2;
  bytes script = 3;
  bytes script_data = 4;
  Policies policies = 5;
  repeated Input inputs = 6;
  repeated Output outputs = 7;
  repeated bytes witnesses = 8;
  ScriptMetadata metadata = 9;
}

message CreateTransaction {
  uint32 bytecode_witness_index = 1;
  bytes salt = 2;
  repeated StorageSlot storage_slots = 3;
  Policies policies = 4;
  repeated Input inputs = 5;
  repeated Output outputs = 6;
  repeated bytes witnesses = 7;
  CreateMetadata metadata = 8;
}

message MintTransaction {
  TxPointer tx_pointer = 1;
  ContractInput input_contract = 2;
  ContractOutput output_contract = 3;
  uint64 mint_amount = 4;
  bytes mint_asset_id = 5;
  uint64 gas_price = 6;
  MintMetadata metadata = 7;
}

message UpgradeTransaction {
  UpgradePurpose purpose = 1;
  Policies policies = 2;
  repeated Input inputs = 3;
  repeated Output outputs = 4;
  repeated bytes witnesses = 5;
  UpgradeMetadata metadata = 6;
}

message UploadTransaction {
  bytes root = 1;
  uint32 witness_index = 2;
  uint32 subsection_index = 3;
  uint32 subsections_number = 4;
  repeated bytes proof_set = 5;
  Policies policies = 6;
  repeated Input inputs = 7;
  repeated Output outputs = 8;
  repeated bytes witnesses = 9;
  UploadMetadata metadata = 10;
}

message BlobTransaction {
  bytes blob_id = 1;
  uint32 witness_index = 2;
  Policies policies = 3;
  repeated Input inputs = 4;
  repeated Output outputs = 5;
  repeated bytes witnesses = 6;
  BlobMetadata metadata = 7;
}

message Policies {
  uint32 bits = 1;
  repeated uint64 values = 2;
}

message Input {
  oneof variant {
    CoinSignedInput coin_signed = 1;
    CoinPredicateInput coin_predicate = 2;
    ContractInput contract = 3;
    MessageCoinSignedInput message_coin_signed = 4;
    MessageCoinPredicateInput message_coin_predicate = 5;
    MessageDataSignedInput message_data_signed = 6;
    MessageDataPredicateInput message_data_predicate = 7;
  }
}

message CoinSignedInput {
  UtxoId utxo_id = 1;
  bytes owner = 2;
  uint64 amount = 3;
  bytes asset_id = 4;
  TxPointer tx_pointer = 5;
  uint32 witness_index = 6;
  uint64 predicate_gas_used = 7;
  bytes predicate = 8;
  bytes predicate_data = 9;
}

message CoinPredicateInput {
  UtxoId utxo_id = 1;
  bytes owner = 2;
  uint64 amount = 3;
  bytes asset_id = 4;
  TxPointer tx_pointer = 5;
  uint32 witness_index = 6;
  uint64 predicate_gas_used = 7;
  bytes predicate = 8;
  bytes predicate_data = 9;
}

message ContractInput {
  UtxoId utxo_id = 1;
  bytes balance_root = 2;
  bytes state_root = 3;
  TxPointer tx_pointer = 4;
  bytes contract_id = 5;
}

message MessageCoinSignedInput {
  bytes sender = 1;
  bytes recipient = 2;
  uint64 amount = 3;
  bytes nonce = 4;
  uint32 witness_index = 5;
  uint64 predicate_gas_used = 6;
  bytes data = 7;
  bytes predicate = 8;
  bytes predicate_data = 9;
}

message MessageCoinPredicateInput {
  bytes sender = 1;
  bytes recipient = 2;
  uint64 amount = 3;
  bytes nonce = 4;
  uint32 witness_index = 5;
  uint64 predicate_gas_used = 6;
  bytes data = 7;
  bytes predicate = 8;
  bytes predicate_data = 9;
}

message MessageDataSignedInput {
  bytes sender = 1;
  bytes recipient = 2;
  uint64 amount = 3;
  bytes nonce = 4;
  uint32 witness_index = 5;
  uint64 predicate_gas_used = 6;
  bytes data = 7;
  bytes predicate = 8;
  bytes predicate_data = 9;
}

message MessageDataPredicateInput {
  bytes sender = 1;
  bytes recipient = 2;
  uint64 amount = 3;
  bytes nonce = 4;
  uint32 witness_index = 5;
  uint64 predicate_gas_used = 6;
  bytes data = 7;
  bytes predicate = 8;
  bytes predicate_data = 9;
}

message Output {
  oneof variant {
    CoinOutput coin = 1;
    ContractOutput contract = 2;
    ChangeOutput change = 3;
    VariableOutput variable = 4;
    ContractCreatedOutput contract_created = 5;
  }
}
message CoinOutput {
  bytes to = 1;
  uint64 amount = 2;
  bytes asset_id = 3;
}
message ContractOutput {
  uint32 input_index = 1;
  bytes balance_root = 2;
  bytes state_root = 3;
}
message ChangeOutput {
  bytes to = 1;
  uint64 amount = 2;
  bytes asset_id = 3;
}
message VariableOutput {
  bytes to = 1;
  uint64 amount = 2;
  bytes asset_id = 3;
}
message ContractCreatedOutput {
  bytes contract_id = 1;
  bytes state_root = 2;
}

message UtxoId {
  bytes tx_id = 1;
  uint32 output_index = 2;
}

message TxPointer {
  uint32 block_height = 1;
  uint32 tx_index = 2;
}

message StorageSlot {
  bytes key = 1;
  bytes value = 2;
}

message ScriptMetadata {
  bytes id = 1;
  uint32 inputs_offset = 2;
  repeated uint32 inputs_offset_at = 3;
  repeated PredicateOffset inputs_predicate_offset_at = 4;
  uint32 outputs_offset = 5;
  repeated uint32 outputs_offset_at = 6;
  uint32 witnesses_offset = 7;
  repeated uint32 witnesses_offset_at = 8;
  uint64 script_gas_limit = 9;
  bytes receipts_root = 10;
  bytes script = 11;
  bytes script_data = 12;
}

message CreateMetadata {
  bytes id = 1;
  uint32 inputs_offset = 2;
  repeated uint32 inputs_offset_at = 3;
  repeated PredicateOffset inputs_predicate_offset_at = 4;
  uint32 outputs_offset = 5;
  repeated uint32 outputs_offset_at = 6;
  uint32 witnesses_offset = 7;
  repeated uint32 witnesses_offset_at = 8;
  bytes contract_id = 9;
  bytes contract_root = 10;
  bytes state_root = 11;
}

message MintMetadata {
  bytes id = 1;
}

message UpgradePurpose {
  oneof variant {
    UpgradeConsensusParameters consensus_parameters = 1;
    UpgradeStateTransition state_transition = 2;
  }
}

message UpgradeConsensusParameters {
  uint32 witness_index = 1;
  bytes checksum = 2;
}

message UpgradeStateTransition {
  bytes root = 1;
}

message UpgradeMetadata {
  bytes id = 1;
  uint32 inputs_offset = 2;
  repeated uint32 inputs_offset_at = 3;
  repeated PredicateOffset inputs_predicate_offset_at = 4;
  uint32 outputs_offset = 5;
  repeated uint32 outputs_offset_at = 6;
  uint32 witnesses_offset = 7;
  repeated uint32 witnesses_offset_at = 8;
  oneof variant {
    UpgradeConsensusParametersMetadata consensus_parameters = 9;
    UpgradeStateTransitionMetadata state_transition = 10;
  }
}

message UpgradeConsensusParametersMetadata {
  bytes consensus_parameters = 1;
  bytes calculated_checksum = 2;
}

message UpgradeStateTransitionMetadata {}

message UploadMetadata {
  bytes id = 1;
  uint32 inputs_offset = 2;
  repeated uint32 inputs_offset_at = 3;
  repeated PredicateOffset inputs_predicate_offset_at = 4;
  uint32 outputs_offset = 5;
  repeated uint32 outputs_offset_at = 6;
  uint32 witnesses_offset = 7;
  repeated uint32 witnesses_offset_at = 8;
}

message BlobMetadata {
  bytes id = 1;
  uint32 inputs_offset = 2;
  repeated uint32 inputs_offset_at = 3;
  repeated PredicateOffset inputs_predicate_offset_at = 4;
  uint32 outputs_offset = 5;
  repeated uint32 outputs_offset_at = 6;
  uint32 witnesses_offset = 7;
  repeated uint32 witnesses_offset_at = 8;
}

message PredicateOffset {
  optional InnerPredicateOffset offset = 1;
}

message InnerPredicateOffset {
  uint32 offset = 1;
  uint32 length = 2;
}


message BlockResponse {
  oneof payload {
    Block literal = 1;
    RemoteBlockRangeResponse remote = 2;
  }
}

message NewBlockSubscriptionRequest {}

service BlockAggregator {
  rpc GetBlockHeight (BlockHeightRequest) returns (BlockHeightResponse);
  rpc GetBlockRange (BlockRangeRequest) returns (stream BlockResponse);
  rpc NewBlockSubscription (NewBlockSubscriptionRequest) returns (stream BlockResponse);
}
