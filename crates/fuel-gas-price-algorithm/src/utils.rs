const BLOCK_COUNT_M: usize = 25;
const PERCENTAGE_COUNT_N: usize = 25;

// precomputed m x n matrix of exp(blocks * ln(1 + percentage / 100))
const PRECOMPUTED_EXP: &[[f64; PERCENTAGE_COUNT_N]; BLOCK_COUNT_M] = &[
    [
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
        1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0,
    ],
    [
        1.0,
        1.01,
        1.02,
        1.03,
        1.04,
        1.05,
        1.06,
        1.07,
        1.08,
        1.09,
        1.1,
        1.11,
        1.12,
        1.13,
        1.1400000000000001,
        1.15,
        1.16,
        1.17,
        1.18,
        1.19,
        1.2,
        1.21,
        1.22,
        1.23,
        1.24,
    ],
    [
        1.0,
        1.0201,
        1.0404,
        1.0609,
        1.0816000000000001,
        1.1025,
        1.1236000000000002,
        1.1449,
        1.1664,
        1.1881000000000002,
        1.2100000000000002,
        1.2321000000000002,
        1.2544000000000002,
        1.2768999999999997,
        1.2996000000000003,
        1.3224999999999998,
        1.3456,
        1.3688999999999998,
        1.3923999999999999,
        1.4161,
        1.44,
        1.4641,
        1.4884,
        1.5129,
        1.5376,
    ],
    [
        1.0,
        1.0303010000000001,
        1.0612080000000002,
        1.092727,
        1.124864,
        1.1576250000000001,
        1.191016,
        1.2250430000000003,
        1.2597120000000002,
        1.2950290000000002,
        1.3310000000000004,
        1.3676310000000003,
        1.4049280000000004,
        1.4428969999999997,
        1.4815440000000004,
        1.5208749999999998,
        1.5608959999999996,
        1.6016129999999997,
        1.6430319999999998,
        1.6851589999999996,
        1.728,
        1.7715609999999997,
        1.815848,
        1.8608669999999998,
        1.9066239999999999,
    ],
    [
        1.0,
        1.04060401,
        1.08243216,
        1.1255088100000001,
        1.1698585600000002,
        1.2155062500000002,
        1.2624769600000003,
        1.3107960100000002,
        1.3604889600000003,
        1.4115816100000005,
        1.4641000000000004,
        1.5180704100000004,
        1.5735193600000006,
        1.6304736099999995,
        1.6889601600000006,
        1.7490062499999994,
        1.8106393599999995,
        1.8738872099999995,
        1.9387777599999996,
        2.00533921,
        2.0736,
        2.14358881,
        2.2153345599999996,
        2.28886641,
        2.3642137599999997,
    ],
    [
        1.0,
        1.0510100501000001,
        1.1040808032,
        1.1592740743,
        1.2166529024000001,
        1.2762815625000004,
        1.3382255776000003,
        1.4025517307000004,
        1.4693280768000005,
        1.5386239549000007,
        1.6105100000000006,
        1.6850581551000008,
        1.7623416832000007,
        1.8424351792999991,
        1.925414582400001,
        2.0113571874999994,
        2.1003416575999996,
        2.1924480356999996,
        2.287757756799999,
        2.3863536598999997,
        2.4883199999999994,
        2.5937424601,
        2.7027081631999996,
        2.8153056842999997,
        2.9316250623999998,
    ],
    [
        1.0,
        1.0615201506010001,
        1.126162419264,
        1.1940522965290001,
        1.2653190184960004,
        1.3400956406250004,
        1.4185191122560004,
        1.5007303518490005,
        1.5868743229440005,
        1.6771001108410009,
        1.7715610000000008,
        1.870414552161001,
        1.9738226851840013,
        2.081951752608999,
        2.1949726239360015,
        2.313060765624999,
        2.436396322815999,
        2.565164201768999,
        2.6995541530239993,
        2.839760855280999,
        2.9859839999999997,
        3.1384283767209995,
        3.2973039591039996,
        3.462825991689,
        3.635215077376,
    ],
    [
        1.0,
        1.07213535210701,
        1.14868566764928,
        1.2298738654248702,
        1.3159317792358403,
        1.4071004226562505,
        1.5036302589913604,
        1.6057814764784306,
        1.7138242687795209,
        1.828039120816691,
        1.948717100000001,
        2.0761601528987113,
        2.2106814074060814,
        2.3526054804481684,
        2.5022687912870416,
        2.6600198804687487,
        2.826219734466559,
        3.001242116069729,
        3.1854739005683186,
        3.379315417784389,
        3.5831807999999987,
        3.7974983358324095,
        4.022710830106879,
        4.25927596977747,
        4.50766669594624,
    ],
    [
        1.0,
        1.0828567056280802,
        1.1716593810022657,
        1.2667700813876164,
        1.3685690504052739,
        1.477455443789063,
        1.5938480745308423,
        1.718186179831921,
        1.8509302102818825,
        1.9925626416901934,
        2.143588810000001,
        2.3045377697175695,
        2.4759631762948113,
        2.65844419290643,
        2.852586422067228,
        3.0590228625390607,
        3.278414891981208,
        3.5114532758015824,
        3.7588592026706156,
        4.021385347163423,
        4.2998169599999985,
        4.594972986357216,
        4.907707212730393,
        5.238909442826288,
        5.589506702973337,
    ],
    [
        1.0,
        1.093685272684361,
        1.195092568622311,
        1.304773183829245,
        1.423311812421485,
        1.5513282159785162,
        1.6894789590026928,
        1.8384592124201555,
        1.9990046271044333,
        2.171893279442311,
        2.357947691000002,
        2.558036924386503,
        2.773078757450189,
        3.0040419379842658,
        3.2519485211566406,
        3.5178762919199196,
        3.802961274698201,
        4.108400332687851,
        4.435453859151326,
        4.785448563124474,
        5.1597803519999985,
        5.559917313492231,
        5.987402799531079,
        6.443858614676334,
        6.930988311686938,
    ],
    [
        1.0,
        1.1046221254112045,
        1.2189944199947573,
        1.3439163793441222,
        1.4802442849183444,
        1.6288946267774422,
        1.7908476965428546,
        1.9671513572895665,
        2.158924997272788,
        2.367363674592119,
        2.593742460100002,
        2.8394209860690185,
        3.105848208344212,
        3.3945673899222197,
        3.7072213141185704,
        4.045557735707907,
        4.411435078649913,
        4.806828389244786,
        5.233835553798564,
        5.694683790118123,
        6.191736422399997,
        6.727499949325599,
        7.304631415427917,
        7.92594609605189,
        8.594425506491802,
    ],
    [
        1.0,
        1.1156683466653166,
        1.2433743083946525,
        1.384233870724446,
        1.5394540563150783,
        1.7103393581163144,
        1.8982985583354257,
        2.1048519522998363,
        2.3316389970546116,
        2.5804264053054102,
        2.853116706110002,
        3.15175729453661,
        3.4785499933455175,
        3.8358611506121085,
        4.22623229809517,
        4.652391396064092,
        5.117264691233899,
        5.623989215416399,
        6.175925953482305,
        6.776673710240566,
        7.430083706879996,
        8.140274938683975,
        8.911650326822059,
        9.748913698143825,
        10.657087628049839,
    ],
    [
        1.0,
        1.1268250301319698,
        1.2682417945625455,
        1.4257608868461793,
        1.6010322185676815,
        1.79585632602213,
        2.0121964718355514,
        2.252191588960825,
        2.5181701168189803,
        2.812664781782897,
        3.1384283767210026,
        3.4984505969356374,
        3.8959759925469806,
        4.3345231001916815,
        4.817904819828494,
        5.350250105473707,
        5.936027041831322,
        6.5800673820371856,
        7.287592625109121,
        8.064241715186272,
        8.916100448255998,
        9.849732675807607,
        10.872213398722911,
        11.991163848716905,
        13.214788658781796,
    ],
    [
        1.0,
        1.1380932804332895,
        1.2936066304537965,
        1.4685337134515648,
        1.6650735073103888,
        1.8856491423232367,
        2.1329282601456847,
        2.4098450001880827,
        2.719623726164499,
        3.065804612143358,
        3.4522712143931034,
        3.8832801625985587,
        4.363493111652619,
        4.898011103216601,
        5.492411494604485,
        6.152787621294762,
        6.885791368524334,
        7.698678836983509,
        8.599359297628762,
        9.596447641071666,
        10.699320537907195,
        11.918176537727208,
        13.264100346441948,
        14.749131533921792,
        16.386337936889422,
    ],
    [
        1.0,
        1.1494742132376223,
        1.3194787630628724,
        1.512589724855112,
        1.7316764476028044,
        1.9799315994393987,
        2.2609039557544257,
        2.5785341502012487,
        2.9371936242576595,
        3.3417270272362605,
        3.7974983358324135,
        4.3104409804844,
        4.887112285050933,
        5.534752546634758,
        6.261349103849113,
        7.075705764488976,
        7.987517987488228,
        9.007454239270704,
        10.147243971201938,
        11.419772692875279,
        12.839184645488631,
        14.42099361064992,
        16.18220242265918,
        18.141431786723807,
        20.31905904174289,
    ],
    [
        1.0,
        1.1609689553699987,
        1.3458683383241299,
        1.557967416600765,
        1.8009435055069165,
        2.0789281794113688,
        2.3965581930996915,
        2.7590315407153363,
        3.1721691141982724,
        3.6424824596875247,
        4.177248169415655,
        4.784589488337685,
        5.4735657592570455,
        6.254270377697276,
        7.137937978387989,
        8.13706162916232,
        9.265520865486343,
        10.538721459946725,
        11.973747886018286,
        13.589529504521586,
        15.407021574586363,
        17.449402268886406,
        19.742286955644204,
        22.313961097670283,
        25.195633211761187,
    ],
    [
        1.0,
        1.1725786449236988,
        1.3727857050906125,
        1.6047064390987882,
        1.8729812457271933,
        2.1828745883819374,
        2.5403516846856733,
        2.95216374856541,
        3.425942643334134,
        3.970305881059402,
        4.594972986357222,
        5.31089433205483,
        6.130393650367892,
        7.067325526797921,
        8.13724929536231,
        9.35762087353667,
        10.748004203964156,
        12.330304108137664,
        14.129022505501577,
        16.171540110380683,
        18.48842588950363,
        21.113776745352546,
        24.085590085885922,
        27.446172150134448,
        31.242585182583866,
    ],
    [
        1.0,
        1.1843044313729356,
        1.4002414191924248,
        1.6528476322717518,
        1.947900495556281,
        2.292018317801034,
        2.6927727857668136,
        3.1588152109649887,
        3.700018054800865,
        4.327633410354748,
        5.054470284992944,
        5.8950927085808615,
        6.866040888412039,
        7.986077845281651,
        9.276464196713034,
        10.76126400456717,
        12.467684876598419,
        14.426455806521064,
        16.67224655649186,
        19.24413273135301,
        22.186111067404354,
        25.547669861876578,
        29.384419904780817,
        33.75879174466537,
        38.74080562640398,
    ],
    [
        1.0,
        1.196147475686665,
        1.4282462475762734,
        1.7024330612399043,
        2.0258165153785326,
        2.406619233691086,
        2.8543391529128224,
        3.3799322757325383,
        3.9960194991849343,
        4.717120417286677,
        5.55991731349224,
        6.543552906524758,
        7.689965795021484,
        9.024267965168264,
        10.57516918425286,
        12.375453605252243,
        14.462514456854164,
        16.87895329362965,
        19.67325093666039,
        22.90051795031009,
        26.62333328088523,
        30.912680532870667,
        35.8489922838326,
        41.523313845938404,
        48.03859897674095,
    ],
    [
        1.0,
        1.2081089504435316,
        1.4568111725277988,
        1.7535060530771018,
        2.106849175993674,
        2.5269501953756404,
        3.0255995020875925,
        3.6165275350338164,
        4.31570105911973,
        5.141661254842477,
        6.115909044841463,
        7.263343726242481,
        8.612761690424064,
        10.197422800640137,
        12.05569287004826,
        14.23177164604008,
        16.776516769950835,
        19.748375353546685,
        23.21443610525926,
        27.251616360869,
        31.947999937062274,
        37.4043434447735,
        43.735770586275784,
        51.073676030504245,
        59.56786273115879,
    ],
    [
        1.0,
        1.220190039947967,
        1.485947395978355,
        1.8061112346694148,
        2.191123143033421,
        2.6532977051444226,
        3.207135472212848,
        3.8696844624861835,
        4.660957143849308,
        5.604410767778301,
        6.72749994932561,
        8.062311536129156,
        9.64629309327495,
        11.523087764723352,
        13.743489871855019,
        16.36653739294609,
        19.460759453142966,
        23.105599163649625,
        27.393034604205923,
        32.42942346943412,
        38.33759992447472,
        45.259255568175945,
        53.357640115256444,
        62.820621517520195,
        73.86414978663689,
    ],
    [
        1.0,
        1.2323919403474468,
        1.5156663438979219,
        1.8602945717094972,
        2.278768068754758,
        2.785962590401644,
        3.399563600545619,
        4.140562374860217,
        5.033833715357253,
        6.108807736878348,
        7.400249944258172,
        8.94916580510336,
        10.803848264467947,
        13.02108917413739,
        15.667578453914723,
        18.821518001888002,
        22.574480965645837,
        27.033551021470053,
        32.32378083296299,
        38.591013928626595,
        46.005119909369675,
        54.76369923749289,
        65.09632094061284,
        77.26936446654983,
        91.59154573542972,
    ],
    [
        1.0,
        1.2447158597509211,
        1.5459796707758804,
        1.9161034088607822,
        2.369918791504948,
        2.925260719921726,
        3.603537416578356,
        4.430401741100432,
        5.436540412585835,
        6.6586004331974005,
        8.140274938683989,
        9.933574043664734,
        12.1003100562041,
        14.71383076677525,
        17.861039437462782,
        21.644745702171196,
        26.18639792014917,
        31.62925469511997,
        38.14206138289632,
        45.92330657506564,
        55.20614389124358,
        66.26407607736638,
        79.41751154754773,
        95.0413182938563,
        113.57351671193292,
    ],
    [
        1.0,
        1.2571630183484304,
        1.5768992641913981,
        1.9735865111266058,
        2.464715543165146,
        3.0715237559178123,
        3.8197496615730575,
        4.740529862977462,
        5.871463645592701,
        7.257874472185167,
        8.95430243255239,
        11.026267188467857,
        13.552347262948594,
        16.62662876645603,
        20.361584958707574,
        24.89145755749688,
        30.37622158737303,
        37.00622799329035,
        45.007632431817655,
        54.648734824328095,
        66.24737266949231,
        80.1795320536133,
        96.88936408800821,
        116.90082150144326,
        140.8311607227968,
    ],
    [
        1.0,
        1.2697346485319148,
        1.6084372494752261,
        2.032794106460404,
        2.5633041648917523,
        3.2250999437137033,
        4.048934641267441,
        5.0723669533858855,
        6.341180737240117,
        7.911083174681831,
        9.849732675807628,
        12.239156579199317,
        15.178628934502433,
        18.78809050609531,
        23.21220685292664,
        28.625176191121415,
        35.23641704135271,
        43.2972867521497,
        53.10900626954485,
        65.03199444095041,
        79.4968472033908,
        97.01723378487208,
        118.20502418736997,
        143.78801044677522,
        174.630639296268,
    ],
];

#[allow(clippy::cast_possible_truncation)]
#[inline]
pub fn cumulative_percentage_change(
    new_exec_price: u64,
    for_height: u32,
    percentage: u64,
    height: u32,
) -> u64 {
    let blocks = height.saturating_sub(for_height);
    // optimized version of `f64::powf(1.0 + percentage_as_decimal, blocks)`
    // x^y = e^(y*ln(x))
    // we gain around 90%
    // if we have blocks / percentage greater than m x n, we have to compute it
    let multiple =
        if blocks > BLOCK_COUNT_M as u32 || percentage > PERCENTAGE_COUNT_N as u64 {
            f64::exp(blocks as f64 * (1.0 + percentage as f64 / 100.0).ln())
        } else {
            PRECOMPUTED_EXP[blocks as usize][percentage as usize]
        };

    let mut approx = new_exec_price as f64 * multiple;

    // Account for rounding errors and take a slightly higher value
    // Around the `ROUNDING_ERROR_CUTOFF` the rounding errors will cause the estimate to be too low.
    // We increase by `ROUNDING_ERROR_COMPENSATION` to account for this.
    // This is an unlikely situation in practice, but we want to guarantee that the actual
    // gas price is always equal or less than the estimate given here
    const ROUNDING_ERROR_CUTOFF: f64 = 16948547188989277.0;
    const ROUNDING_ERROR_COMPENSATION: f64 = 2000.0;

    // prevent branching in compiled code
    approx +=
        ROUNDING_ERROR_COMPENSATION * ((approx > ROUNDING_ERROR_CUTOFF) as u8 as f64);

    // `f64` over `u64::MAX` are cast to `u64::MAX`
    approx.ceil() as u64
}

#[cfg(test)]
mod tests {
    use super::*;
    use proptest::prelude::*;

    // keep the previous implementation for comparison
    #[allow(clippy::cast_possible_truncation)]
    fn cumulative_percentage_change_plain(
        start_gas_price: u64,
        best_height: u32,
        percentage: u64,
        target_height: u32,
    ) -> u64 {
        let blocks = target_height.saturating_sub(best_height) as f64;
        let percentage_as_decimal = percentage as f64 / 100.0;
        let multiple = (1.0f64 + percentage_as_decimal).powf(blocks);
        let mut approx = start_gas_price as f64 * multiple;
        // Account for rounding errors and take a slightly higher value
        // Around the `ROUNDING_ERROR_CUTOFF` the rounding errors will cause the estimate to be too low.
        // We increase by `ROUNDING_ERROR_COMPENSATION` to account for this.
        // This is an unlikely situation in practice, but we want to guarantee that the actual
        // gas price is always equal or less than the estimate given here
        const ROUNDING_ERROR_CUTOFF: f64 = 16948547188989277.0;
        if approx > ROUNDING_ERROR_CUTOFF {
            const ROUNDING_ERROR_COMPENSATION: f64 = 2000.0;
            approx += ROUNDING_ERROR_COMPENSATION;
        }
        // `f64` over `u64::MAX` are cast to `u64::MAX`
        approx.ceil() as u64
    }

    proptest! {
        #[test]
        fn plain_and_optimized_produce_same_result(
            start_gas_price in 0..10000u64,
            best_height in 0..100000u32,
            offset in 0..20u32,
            percentage in 0..20u64,
        ) {
            #[allow(clippy::arithmetic_side_effects)]
            let target_height = best_height + offset;

            let plain = cumulative_percentage_change_plain(start_gas_price, best_height, percentage, target_height);
            let optimized = cumulative_percentage_change(start_gas_price, best_height, percentage, target_height);

            prop_assert_eq!(plain, optimized);
        }
    }
}
